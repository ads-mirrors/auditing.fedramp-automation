<?xml version="1.0" encoding="UTF-8"?>
<metaschema-meta-constraints xmlns="http://csrc.nist.gov/ns/oscal/metaschema/1.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://csrc.nist.gov/ns/oscal/metaschema/1.0 https://raw.githubusercontent.com/metaschema-framework/metaschema/0441e6d4c9bce5b6c40b4647148019e4f47bed08/schema/xml/metaschema-meta-constraints.xsd">
    <!-- ============================== -->
    <!-- FedRAMP Constraint Style guide -->
    <!-- ============================== -->

    <context>
        <metapath target="/metaschema-meta-constraints"/>
        <constraints>
            <let var="all-constraints" expression="//expect | //allowed-values | //index-has-key"/>
            <let var="id-map" expression="map:merge($all-constraints ! map:entry(@id, ''))"/>
            <let var="duplicate-ids" expression="map:keys($id-map)[for $key in . return count($all-constraints[@id = $key]) > 1]"/>
            
            <let var="single-metapath-contexts" expression="//context[count(metapath) = 1]"/>
            <let var="target-map" expression="map:merge($single-metapath-contexts/metapath ! map:entry(@target, ''))"/>
            <let var="duplicate-targets" expression="map:keys($target-map)[for $key in . return count($single-metapath-contexts/metapath[@target = $key]) > 1]"/>
            <let var="all-lets" expression="//let"/>
            <let var="let-var-map" expression="map:merge($all-lets ! map:entry(@var, ''))"/>
            <let var="duplicate-vars" expression="map:keys($let-var-map)[for $key in . return count($all-lets[@var = $key]) > 1]"/>
        <expect id="frr102" target="$single-metapath-contexts/metapath[@target = $duplicate-targets]" 
                    test="false()" level="ERROR">
                <formal-name>Single Metapath Target Must Be Unique</formal-name>
                <prop namespace="https://docs.oasis-open.org/sarif/sarif/v2.1.0" name="help-url" value="https://github.com/GSA/fedramp-automation/blob/develop/src/validations/styleguides/README.md#frr102"/>
                <message>A context element with a single metapath MUST NOT have the same target as another context with a single metapath.</message>
            </expect>
           <expect id="frr104" target="//expect | //index-has-key" test="count(prop[@namespace = 'https://docs.oasis-open.org/sarif/sarif/v2.1.0' and @name = 'help-url']) eq 1 and matches(prop[@namespace = 'https://docs.oasis-open.org/sarif/sarif/v2.1.0' and @name = 'help-url']/@value, '^https:\/\/automate\.fedramp\.gov')" level="ERROR">
                <formal-name>Constraints Have a Help URL Property</formal-name>
                <prop namespace="https://docs.oasis-open.org/sarif/sarif/v2.1.0" name="help-url" value="https://github.com/GSA/fedramp-automation/blob/develop/src/validations/styleguides/STYLE.md#frr104"/>
                <message>A FedRAMP constraint MUST define a valid help URL.</message>
            </expect>
            <!-- TODO: Uniqueness check needs to be improved when support is added for a function like distinct-values() -->
            <expect id="frr105" target="$all-constraints" 
                    test="@id and not(@id = $duplicate-ids)" level="ERROR">
                <formal-name>Constraints Have a Unique ID</formal-name>
                <prop namespace="https://docs.oasis-open.org/sarif/sarif/v2.1.0" name="help-url" value="https://github.com/GSA/fedramp-automation/blob/develop/src/validations/styleguides/STYLE.md#frr105"/>
                <message>A FedRAMP constraint MUST have a unique id. ID "{@id}" is used multiple times.</message>
            </expect>
            <expect id="frr106" target="//expect | //allowed-values | //index-has-key" test="matches(@id, '^frr[0-9]+$')" level="ERROR">
                <formal-name>Constraints Have IDs with Lowercase String "frr" Followed By Numbers</formal-name>
                <prop namespace="https://docs.oasis-open.org/sarif/sarif/v2.1.0" name="help-url" value="https://github.com/GSA/fedramp-automation/blob/develop/src/validations/styleguides/STYLE.md#frr106"/>
                <message>A FedRAMP constraint id MUST only consist of the lowercase string "frr" followed by numbers 0-9.</message>
            </expect>
            <expect id="frr107" target="//expect | //allowed-values | //index-has-key" test="matches(@level, '(CRITICAL|ERROR|WARNING|INFORMATIONAL|DEBUG)')" level="ERROR">
                <formal-name>Constraints Have an Explicit Severity Level</formal-name>
                <prop namespace="https://docs.oasis-open.org/sarif/sarif/v2.1.0" name="help-url" value="https://github.com/GSA/fedramp-automation/blob/develop/src/validations/styleguides/STYLE.md#frr107"/>
                <message>A FedRAMP constraint MUST specify a valid severity level.</message>
            </expect>
            <expect id="frr109" target="//expect" test="message" level="ERROR">
                <formal-name>Expect Constraint Message Field Required</formal-name>
                <prop namespace="https://docs.oasis-open.org/sarif/sarif/v2.1.0" name="help-url" value="https://github.com/GSA/fedramp-automation/blob/develop/src/validations/styleguides/STYLE.md#frr109"/>
                <message>A FedRAMP constraint MUST include a message describing the requirement.</message>
            </expect>
            <expect id="frr112" target="//expect" test="matches(message, '(MUST|MUST NOT|REQUIRED|SHALL|SHALL NOT|SHOULD|SHOULD NOT|RECOMMENDED|MAY|OPTIONAL|\{\$[^}]+\})')" level="ERROR">
                <formal-name>IETF BCP14 Keywords in Constraint Messages</formal-name>
                <prop namespace="https://docs.oasis-open.org/sarif/sarif/v2.1.0" name="help-url" value="https://github.com/GSA/fedramp-automation/blob/develop/src/validations/styleguides/STYLE.md#frr112"/>
                <message>A FedRAMP constraint MUST include one of the IETF BCP14 keywords in the message.</message>
            </expect>
            <expect id="frr116" target="//expect | //allowed-values | //index-has-key" test="formal-name" level="ERROR">
                <formal-name>Constraints Formal Names Required</formal-name>
                <prop namespace="https://docs.oasis-open.org/sarif/sarif/v2.1.0" name="help-url" value="https://github.com/GSA/fedramp-automation/blob/develop/src/validations/styleguides/README.md#frr116"/>
                <message>A FedRAMP constraint MUST include a formal name.</message>
            </expect>
            <expect id="frr120" target="//let[@var = $duplicate-vars]" test="false()" level="ERROR">
                <formal-name>Let Variables Must Have Unique Names</formal-name>
                <prop namespace="https://docs.oasis-open.org/sarif/sarif/v2.1.0" name="help-url" value="https://github.com/GSA/fedramp-automation/blob/develop/src/validations/styleguides/README.md#frr117"/>
                <message>A let variable MUST have a unique name. Variable "{@var}" is used multiple times.</message>
            </expect>

        </constraints>
</context>
</metaschema-meta-constraints>
